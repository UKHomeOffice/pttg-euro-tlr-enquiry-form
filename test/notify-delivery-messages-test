const settings = require('../config');
const simpleMock = require('simple-mock');
const assert = require('chai').assert;
const mockRequire = require('mock-require');

let notifyMessages;
let mockSlackNotify;

describe('Slack delivery messages', function(){

    beforeEach(function () {
        mockSlackNotify = simpleMock.mock({}, 'slack-notify');
        mockRequire('slack-notify', function (webHookUrl) {
            return {
                alert: mockSlackNotify
            };
        });
        notifyMessages = mockRequire.reRequire('../apps/pttg-rps-enquiry-form/behaviours/notify-delivery-messages');
    });
    it('Should return 200 for a POST with authorised bearer token', function(){
        const mockRequest = {
            method: 'POST',
            headers: {
                authorization: settings.bearerToken
            },
            body: {
                status: 'temporary-failure'
            }
        };
        const mockStatus = simpleMock.mock({}, 'status').returnWith({
            end: function () {}
        });
        const mockResponse = {
            status: mockStatus
        };

        notifyMessages(mockRequest, mockResponse);

        assert.isTrue(mockStatus.called);
        assert.equal(mockStatus.lastCall.arg, 200);
    });

    it('Should send slack alert for a POST with authorised bearer token', function () {
        const mockRequest = {
            method: 'POST',
            headers: {
                authorization: settings.bearerToken
            },
            body: {
                status: 'temporary-failure'
            }
        };
        const mockStatus = simpleMock.mock({}, 'status').returnWith({
            end: function () {
            }
        });
        const mockResponse = {
            status: mockStatus
        };

        notifyMessages(mockRequest, mockResponse);

        assert.equal(mockSlackNotify.callCount, 1);
        assert.equal(mockSlackNotify.lastCall.arg.text, 'Failed delivery notification');
    });


});
// it('Should return 200 for a POST with authorised bearer token',
//     function(done) {
//         request
//             .post('http://localhost:8080/notify-messages')
//             .set('Authorization', settings.bearerToken)
//             .end((err, res) => {
//                 expect(res).to.exist;
//                 expect(res.status).to.equal(200);
//                 done();
//             });
//     });
//
// it('Should return 405 for a GET with authorised bearer token',
//     function(done) {
//         request
//             .get('http://localhost:8080/notify-messages')
//             .set('Authorization', settings.bearerToken)
//             .end((err, res) => {
//                 expect(res).to.exist;
//                 expect(res.status).to.equal(405);
//                 done();
//             });
//     });
//
// it('Should return 405 for POST with unauthorised bearer token',
//     function(done) {
//         request
//             .post('http://localhost:8080/notify-messages')
//             .set('Authorization', 'Bearer ' + '123456789')
//             .end((err, res) => {
//                 expect(res).to.exist;
//                 expect(res.status).to.equal(405);
//                 done();
//             });
//     });
//
// it('Should return 405 for GET with unauthorised bearer token',
//     function(done) {
//         request
//             .get('http://localhost:8080/notify-messages')
//             .set('Authorization', 'Bearer ' + '123456789')
//             .end((err, res) => {
//                 expect(res).to.exist;
//                 expect(res.status).to.equal(405);
//                 done();
//             });
//     });
